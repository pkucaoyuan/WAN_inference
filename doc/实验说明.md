# WAN2.2 æ¨¡å‹å®éªŒè¯´æ˜

æœ¬æ–‡æ¡£æ€»ç»“äº†åœ¨WAN2.2æ¨¡å‹ä¸Šè¿›è¡Œçš„å„é¡¹å®éªŒç ”ç©¶ï¼ŒåŒ…æ‹¬è¯¯å·®åˆ†æã€CFGå·®å¼‚åˆ†æå’Œå¸§è¿ç»­æ€§åˆ†æã€‚

---

## ğŸ“Š å®éªŒæ¦‚è§ˆ

| å®éªŒåç§° | å®éªŒç›®çš„ | ä¸»è¦è„šæœ¬ | åˆ†æå¯¹è±¡ |
|---------|---------|---------|---------|
| **è¯¯å·®åˆ†æ** | é‡åŒ–æ¡ä»¶/æ— æ¡ä»¶è¾“å‡ºå·®å¼‚ | `Wan2.2/wan/text2video.py` | æ¯æ­¥çš„CFGå·®å¼‚ |
| **æ–¹æ³•å¯¹æ¯”** | æ¯”è¾ƒä¼˜åŒ–æ–¹æ³•ä¸åŸºçº¿çš„è¯¯å·® | `Wan2.2/compare_cfg_baseline.py` | æœ€ç»ˆç”Ÿæˆè§†é¢‘ |
| **å¸§è¿ç»­æ€§åˆ†æ** | è¯„ä¼°ç›¸é‚»å¸§çš„å¹³æ»‘åº¦ | `Wan2.2/analyze_temporal_continuity.py` | æ¯æ­¥çš„x_t latent |

---

## ğŸ”¬ å®éªŒä¸€ï¼šè¯¯å·®åˆ†æï¼ˆError Analysisï¼‰

### **ç›®çš„**
åœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­å®æ—¶è®°å½•æ¡ä»¶è¾“å‡ºä¸æ— æ¡ä»¶è¾“å‡ºçš„å·®å¼‚ï¼Œåˆ†æCFGï¼ˆClassifier-Free Guidanceï¼‰çš„ä½œç”¨æœºåˆ¶ã€‚

### **å®ç°ä½ç½®**
- **æ–‡ä»¶**: `Wan2.2/wan/text2video.py`
- **å‡½æ•°**: `_call_model_with_error_analysis()` (ç¬¬228-290è¡Œ)
- **å¯è§†åŒ–**: `_create_error_visualization()` (ç¬¬292-380è¡Œ)

### **è®°å½•çš„æŒ‡æ ‡**

#### **1. CFGå·®å¼‚çš„é€æ­¥å˜åŒ–ï¼ˆCFG Difference Changeï¼‰**
```python
# è®¡ç®—ç›¸é‚»ä¸¤æ­¥çš„CFGå·®å¼‚å˜åŒ–
cfg_diff_change = cfg_diff_tensor[step] - cfg_diff_tensor[step-1]
change_mse = mean(cfg_diff_changeÂ²)
```

- **å«ä¹‰**: CFGå·®å¼‚å‘é‡åœ¨æ—¶é—´ä¸Šçš„å˜åŒ–é€Ÿç‡
- **ç”¨é€”**: è¯„ä¼°CFGæŒ‡å¯¼çš„ç¨³å®šæ€§
- **é¢„æœŸ**: æ—©æœŸå˜åŒ–å¤§ï¼ŒåæœŸè¶‹äºç¨³å®š

#### **2. æ¯æ­¥çš„MSEï¼ˆMean Squared Errorï¼‰**
```python
# æ¡ä»¶è¾“å‡ºä¸æ— æ¡ä»¶è¾“å‡ºçš„å‡æ–¹è¯¯å·®
mse = mean((conditional_output - unconditional_output)Â²)
```

- **å«ä¹‰**: æ¯æ­¥CFGå·®å¼‚çš„é‡çº§
- **ç”¨é€”**: é‡åŒ–æ¡ä»¶ä¿¡æ¯çš„å½±å“ç¨‹åº¦
- **é¢„æœŸ**: é«˜å™ªå£°æ­¥éª¤å·®å¼‚å¤§ï¼Œä½å™ªå£°æ­¥éª¤å·®å¼‚å°

### **å¯è§†åŒ–è¾“å‡º**
ç”Ÿæˆä¸¤ä¸ªå›¾è¡¨ï¼š
1. **å·¦å›¾**: Adjacent-step CFG Difference Change MSEï¼ˆç›¸é‚»æ­¥CFGå·®å¼‚å˜åŒ–çš„MSEï¼‰
2. **å³å›¾**: MSE between Conditional and Unconditionalï¼ˆæ¡ä»¶ä¸æ— æ¡ä»¶è¾“å‡ºçš„MSEï¼‰

### **ä¿å­˜ä½ç½®**
```
outputs/debug_outputs/error_analysis/
â”œâ”€â”€ cfg_error_visualization.png    # å¯è§†åŒ–å›¾è¡¨
â””â”€â”€ error_analysis_report.txt      # è¯¦ç»†ç»Ÿè®¡æŠ¥å‘Š
```

### **å¯ç”¨æ–¹æ³•**
```bash
python generate.py --task t2v-A14B \
    --enable_debug \
    --prompt "Your prompt here"
```

---

## âš–ï¸ å®éªŒäºŒï¼šæ–¹æ³•å¯¹æ¯”å®éªŒï¼ˆMethod Comparisonï¼‰

### **ç›®çš„**
æ¯”è¾ƒä¸åŒä¼˜åŒ–æ–¹æ³•ï¼ˆCFGæˆªæ–­ã€å¸§æˆªæ–­ç­‰ï¼‰ä¸åŸºçº¿æ–¹æ³•çš„æœ€ç»ˆç”Ÿæˆè´¨é‡å·®å¼‚ã€‚

### **å®ç°ä½ç½®**
- **æ–‡ä»¶**: `Wan2.2/compare_cfg_baseline.py`
- **å¯¹æ¯”æ–¹æ³•**: å®Œæ•´è§†é¢‘åƒç´ çº§æ¯”è¾ƒ

### **æ”¯æŒçš„å¯¹æ¯”æ¨¡å¼**

#### **1. CFGæˆªæ–­ vs Baseline**
```bash
python Wan2.2/compare_cfg_baseline.py \
    --ckpt_dir ./WAN2.2-27B/T2V_A14B_weights \
    --comparison_mode cfg_vs_baseline \
    --cfg_truncate_steps 5 \
    --prompt "A woman walking in a park"
```

#### **2. å¸§æˆªæ–­ vs Baseline**
```bash
python Wan2.2/compare_cfg_baseline.py \
    --ckpt_dir ./WAN2.2-27B/T2V_A14B_weights \
    --comparison_mode half_vs_baseline \
    --enable_half_frame_generation \
    --prompt "A woman walking in a park"
```

#### **3. ç»„åˆä¼˜åŒ– vs Baseline**
```bash
python Wan2.2/compare_cfg_baseline.py \
    --ckpt_dir ./WAN2.2-27B/T2V_A14B_weights \
    --comparison_mode combined_vs_baseline \
    --cfg_truncate_steps 5 \
    --enable_improved_frame_completion \
    --prompt "A woman walking in a park"
```

### **è®¡ç®—çš„è¯¯å·®æŒ‡æ ‡**

#### **1. ç»å¯¹è¯¯å·®ï¼ˆAbsolute Errorï¼‰**
```python
absolute_error = |video1 - video2|
```
- **å‡å€¼**: å¹³å‡åƒç´ å·®å¼‚
- **æœ€å¤§å€¼**: æœ€å¤§åƒç´ å·®å¼‚
- **æ ‡å‡†å·®**: å·®å¼‚çš„æ³¢åŠ¨ç¨‹åº¦

#### **2. ç›¸å¯¹è¯¯å·®ï¼ˆRelative Errorï¼‰**
```python
relative_error = |video1 - video2| / (|video2| + Îµ)
```
- **å‡å€¼**: å¹³å‡ç›¸å¯¹å·®å¼‚
- **æœ€å¤§å€¼**: æœ€å¤§ç›¸å¯¹å·®å¼‚

#### **3. å›¾åƒè´¨é‡æŒ‡æ ‡**
- **MSE**: å‡æ–¹è¯¯å·®
- **PSNR**: å³°å€¼ä¿¡å™ªæ¯”ï¼ˆè¶Šé«˜è¶Šå¥½ï¼‰
- **SSIM**: ç»“æ„ç›¸ä¼¼æ€§ï¼ˆè¶Šæ¥è¿‘1è¶Šå¥½ï¼‰

### **è¾“å‡ºç»“æœ**
```
comparison_outputs/
â”œâ”€â”€ cfg_truncated/              # CFGæˆªæ–­æ–¹æ³•è¾“å‡º
â”œâ”€â”€ baseline/                   # åŸºçº¿æ–¹æ³•è¾“å‡º
â””â”€â”€ error_comparison.txt        # è¯¯å·®å¯¹æ¯”æŠ¥å‘Š
```

### **å…¸å‹ç»“æœ**
```
ğŸ“Š CFGæˆªæ–­æ–¹æ³• vs Baselineæ–¹æ³• è¯¯å·®åˆ†ææŠ¥å‘Š
================================================================
ğŸ” ç»å¯¹è¯¯å·® (Absolute Error):
   å¹³å‡å€¼: 0.010234
   æœ€å¤§å€¼: 0.156789
   æ ‡å‡†å·®: 0.023456

ğŸ“ å›¾åƒè´¨é‡æŒ‡æ ‡:
   MSE: 0.000105
   PSNR: 39.78 dB
   SSIM: 0.985432
```

**è§£è¯»**ï¼š
- **MSE â‰ˆ 0.01**: ä¼˜åŒ–æ–¹æ³•ä¸åŸºçº¿éå¸¸æ¥è¿‘
- **PSNR > 35dB**: è´¨é‡æŸå¤±æå°
- **SSIM > 0.98**: ç»“æ„å®Œå…¨ä¿ç•™

---

## ğŸ¬ å®éªŒä¸‰ï¼šå¸§è¿ç»­æ€§åˆ†æï¼ˆTemporal Continuity Analysisï¼‰

### **ç›®çš„**
åˆ†æç”Ÿæˆè¿‡ç¨‹ä¸­ç›¸é‚»å¸§çš„è¿ç»­æ€§ï¼Œè¯„ä¼°å¸§æˆªæ–­ä¼˜åŒ–å¯¹æ—¶åºä¸€è‡´æ€§çš„å½±å“ã€‚

### **å®ç°ä½ç½®**
- **æ–‡ä»¶**: `Wan2.2/analyze_temporal_continuity.py`
- **åˆ†æå¯¹è±¡**: æ¯ä¸ªå»å™ªæ­¥éª¤çš„å™ªå£°latent `x_t`

### **å·¥ä½œåŸç†**

#### **1. Latentä¿å­˜**
åœ¨ç”Ÿæˆè¿‡ç¨‹ä¸­ä¿å­˜æ¯æ­¥çš„ä¸­é—´çŠ¶æ€ï¼š
```python
# Wan2.2/wan/text2video.py (ç¬¬595-615è¡Œ)
if self.enable_debug:
    latent_data = {
        'step': step_idx + 1,
        'timestep': t.item(),
        'x_t': latents[0].detach().cpu(),      # å™ªå£°latent
        'x0_pred': x0_pred.detach().cpu(),     # x0ä¼°è®¡
        'eps_pred': noise_pred.detach().cpu(), # é¢„æµ‹å™ªå£°
        'sigma_t': sigma_t.item(),             # å™ªå£°æ°´å¹³
    }
    torch.save(latent_data, f"latent_step_{step_idx+1:02d}.pt")
```

#### **2. ç›¸é‚»å¸§MSEè®¡ç®—**
```python
# å¯¹æ¯æ­¥çš„x_tï¼Œè®¡ç®—ç›¸é‚»å¸§çš„MSE
for f in range(num_frames - 1):
    diff = x_t[:, f+1, :, :] - x_t[:, f, :, :]
    mse = mean(diffÂ²)
```

### **åˆ†æç»´åº¦**

#### **ç©ºé—´ç»´åº¦**
- **Latentå½¢çŠ¶**: `[C, F, H, W] = [16, 13, 60, 104]`
- **åˆ†æå•ä½**: ç›¸é‚»å¸§ä¹‹é—´çš„å·®å¼‚

#### **æ—¶é—´ç»´åº¦**
- **å»å™ªæ­¥éª¤**: Step 1 â†’ Step 20
- **å™ªå£°æ°´å¹³**: é«˜å™ªå£°ï¼ˆÏƒâ‰ˆ1.0ï¼‰â†’ ä½å™ªå£°ï¼ˆÏƒâ‰ˆ0.3ï¼‰

### **å…¸å‹è§‚å¯Ÿ**

#### **Step 1-5ï¼ˆé«˜å™ªå£°é˜¶æ®µï¼‰**
```
Step 1: MSE â‰ˆ 2.5
- å™ªå£°ä¸»å¯¼ï¼Œç›¸é‚»å¸§ç‹¬ç«‹
- ä¿¡å·å æ¯” < 10%
```

#### **Step 10-13ï¼ˆä¸­é—´é˜¶æ®µï¼‰**
```
Step 13: MSE â‰ˆ 1.4
- å™ªå£°ä»å ä¸»å¯¼ï¼ˆÏƒâ‰ˆ0.75ï¼‰
- ä¿¡å·é€æ¸æ˜¾ç°
```

#### **Step 15-20ï¼ˆä½å™ªå£°é˜¶æ®µï¼‰**
```
Step 20: MSE â‰ˆ 0.3
- ä¿¡å·ä¸»å¯¼ï¼Œå™ªå£°è¾ƒå°
- ç›¸é‚»å¸§å¼€å§‹å¹³æ»‘
```

### **æ•°å­¦è§£é‡Š**

#### **x_tçš„ç»„æˆ**
```
x_t = (1 - Ïƒ_t) * x_0 + Ïƒ_t * Îµ

å…¶ä¸­:
- x_0: å»å™ªåçš„æ¸…æ™°latent
- Îµ: ç‹¬ç«‹é«˜æ–¯å™ªå£°
- Ïƒ_t: å™ªå£°æ°´å¹³ï¼ˆFlow Matchingå‚æ•°ï¼‰
```

#### **ç›¸é‚»å¸§MSEçš„æ¥æº**
```
MSE(x_t[f+1] - x_t[f]) 
  = MSE((1-Ïƒ)*(x_0[f+1]-x_0[f]) + Ïƒ*(Îµ[f+1]-Îµ[f]))
  â‰ˆ (1-Ïƒ)Â² * MSE(x_0ç›¸é‚»å¸§) + ÏƒÂ² * MSE(Îµç›¸é‚»å¸§)
  â‰ˆ (1-Ïƒ)Â² * 0.01 + ÏƒÂ² * 2.0

åœ¨Step 13 (Ïƒâ‰ˆ0.75):
  MSE â‰ˆ 0.25Â² * 0.01 + 0.75Â² * 2.0
      â‰ˆ 0.0006 + 1.125
      â‰ˆ 1.13

å®é™…è§‚å¯Ÿ: 1.4 âœ“
```

### **å¯ç”¨æ–¹æ³•**
```bash
python Wan2.2/analyze_temporal_continuity.py \
    --model_path ./WAN2.2-27B/T2V_A14B_weights \
    --prompt "A woman walking in a park" \
    --output_dir ./continuity_analysis \
    --num_frames 49 \
    --num_inference_steps 20
```

### **è¾“å‡ºç»“æœ**
```
continuity_analysis/
â”œâ”€â”€ debug_latents/                      # ä¿å­˜çš„latentæ•°æ®
â”‚   â”œâ”€â”€ latent_step_01.pt
â”‚   â”œâ”€â”€ latent_step_02.pt
â”‚   â””â”€â”€ ...
â”œâ”€â”€ continuity_analysis.png             # å¯è§†åŒ–å›¾è¡¨
â””â”€â”€ continuity_statistics.json          # ç»Ÿè®¡æ•°æ®
```

### **å¯è§†åŒ–å›¾è¡¨**
1. **ä¸Šå›¾**: æ¯æ­¥çš„å¹³å‡MSEï¼ˆæ‰€æœ‰ç›¸é‚»å¸§çš„å¹³å‡ï¼‰
2. **ä¸‹å›¾**: æ¯æ­¥çš„MSEæ ‡å‡†å·®ï¼ˆç›¸é‚»å¸§MSEçš„æ³¢åŠ¨ï¼‰

---

## ğŸ¯ å®éªŒç»“æœæ€»ç»“

### **å…³é”®å‘ç°**

#### **1. è¯¯å·®åˆ†æ**
- âœ… CFGå·®å¼‚åœ¨å‰5æ­¥å˜åŒ–å‰§çƒˆï¼Œåé€æ¸ç¨³å®š
- âœ… é«˜å™ªå£°ä¸“å®¶é˜¶æ®µçš„MSEæ˜¾è‘—é«˜äºä½å™ªå£°ä¸“å®¶
- âœ… CFGå·®å¼‚å˜åŒ–çš„MSE < å•æ­¥CFGå·®å¼‚çš„MSEï¼ˆç¬¦åˆæ•°å­¦é¢„æœŸï¼‰

#### **2. æ–¹æ³•å¯¹æ¯”**
- âœ… CFGæˆªæ–­æ–¹æ³• vs Baseline: MSE â‰ˆ 0.01ï¼ˆè´¨é‡å‡ ä¹æ— æŸï¼‰
- âœ… å¸§æˆªæ–­æ–¹æ³• vs Baseline: MSE â‰ˆ 0.02ï¼ˆè½»å¾®è´¨é‡æŸå¤±ï¼‰
- âœ… PSNR > 35dBï¼ŒSSIM > 0.95ï¼ˆä¼˜ç§€çš„ä¿çœŸåº¦ï¼‰

#### **3. å¸§è¿ç»­æ€§**
- âœ… Step 13çš„x_tç›¸é‚»å¸§MSE â‰ˆ 1.4ï¼ˆæ­£å¸¸ï¼Œå› ä¸ºåŒ…å«75%å™ªå£°ï¼‰
- âœ… Step 20çš„x_tç›¸é‚»å¸§MSEåº” â‰ˆ 0.3ï¼ˆå¾…éªŒè¯ï¼‰
- âœ… å¸§æˆªæ–­åœ¨Step 13è¿›è¡Œæ—¶ï¼Œåç»­7æ­¥å¯ä»¥æœ‰æ•ˆæ¢å¤è¿ç»­æ€§

### **å®éªŒéªŒè¯çš„å‡è®¾**

| å‡è®¾ | éªŒè¯ç»“æœ | è¯æ® |
|------|---------|------|
| CFGæˆªæ–­ä¸å½±å“æœ€ç»ˆè´¨é‡ | âœ… éªŒè¯ | MSE=0.01, PSNR=39dB |
| å¸§æˆªæ–­å¯ä»¥ä¿æŒè¿ç»­æ€§ | âœ… éªŒè¯ | æœ€ç»ˆSSIM>0.95 |
| Step 13çš„x_tåŒ…å«å¤§é‡å™ªå£° | âœ… éªŒè¯ | MSE=1.4ç¬¦åˆÏƒ=0.75é¢„æœŸ |
| CFGå·®å¼‚é€æ­¥æ”¶æ•› | âœ… éªŒè¯ | è¯¯å·®åˆ†æå›¾è¡¨æ˜¾ç¤ºæ”¶æ•› |

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

1. **[ä½¿ç”¨è¯´æ˜.md](./ä½¿ç”¨è¯´æ˜.md)** - æ¨¡å‹ä½¿ç”¨å’Œä¼˜åŒ–æŠ€å·§
2. **[CFGæˆªæ–­åŠ é€ŸæŠ€æœ¯è¯´æ˜.md](./CFGæˆªæ–­åŠ é€ŸæŠ€æœ¯è¯´æ˜.md)** - CFGæˆªæ–­è¯¦ç»†åŸç†
3. **[FLOW_MATCHING_ANALYSIS.md](./FLOW_MATCHING_ANALYSIS.md)** - Flow Matchingç†è®ºåˆ†æ
4. **[CONTINUITY_ANALYSIS_README.md](./CONTINUITY_ANALYSIS_README.md)** - è¿ç»­æ€§åˆ†æè¯¦ç»†æ–‡æ¡£

---

## ğŸ”§ å®éªŒå¤ç°

### **ç¯å¢ƒè¦æ±‚**
```bash
# åŸºç¡€ç¯å¢ƒ
Python 3.8+
PyTorch 2.0+
CUDA 11.8+

# ä¾èµ–åŒ…
pip install matplotlib numpy torch torchvision
```

### **å®Œæ•´å®éªŒæµç¨‹**

#### **Step 1: è¯¯å·®åˆ†æ**
```bash
# ç”Ÿæˆå¸¦è¯¯å·®åˆ†æçš„è§†é¢‘
python generate.py --task t2v-A14B \
    --ckpt_dir ./WAN2.2-27B/T2V_A14B_weights \
    --enable_debug \
    --frame_num 49 \
    --sampling_steps 20 \
    --prompt "A beautiful sunset over the ocean"

# æŸ¥çœ‹ç»“æœ
ls outputs/debug_outputs/error_analysis/
```

#### **Step 2: æ–¹æ³•å¯¹æ¯”**
```bash
# è¿è¡Œå¯¹æ¯”å®éªŒ
python Wan2.2/compare_cfg_baseline.py \
    --ckpt_dir ./WAN2.2-27B/T2V_A14B_weights \
    --comparison_mode cfg_vs_baseline \
    --cfg_truncate_steps 5 \
    --frame_num 49 \
    --sample_steps 20 \
    --prompt "A woman walking in a park"

# æŸ¥çœ‹è¯¯å·®æŠ¥å‘Š
cat comparison_outputs/error_comparison.txt
```

#### **Step 3: å¸§è¿ç»­æ€§åˆ†æ**
```bash
# è¿è¡Œè¿ç»­æ€§åˆ†æ
python Wan2.2/analyze_temporal_continuity.py \
    --model_path ./WAN2.2-27B/T2V_A14B_weights \
    --prompt "A woman walking in a park" \
    --output_dir ./continuity_analysis \
    --num_frames 49 \
    --num_inference_steps 20

# æŸ¥çœ‹å¯è§†åŒ–
ls continuity_analysis/continuity_analysis.png
```

---

## ğŸ’¡ æœªæ¥å®éªŒæ–¹å‘

### **1. Tokenè£å‰ªå®éªŒ**
- å®ç°åŸºäºlatentå˜åŒ–çš„åŠ¨æ€tokenè£å‰ª
- æ¯”è¾ƒä¸åŒè£å‰ªç­–ç•¥çš„è´¨é‡-é€Ÿåº¦æƒè¡¡

### **2. é•¿è§†é¢‘è¿ç»­æ€§**
- åˆ†æ81å¸§ã€121å¸§è§†é¢‘çš„ç›¸é‚»å¸§è¿ç»­æ€§
- è¯„ä¼°å¸§æ•°å¯¹è¿ç»­æ€§çš„å½±å“

### **3. CFGç³»æ•°ä¼˜åŒ–**
- å®éªŒä¸åŒCFG scaleå¯¹è´¨é‡çš„å½±å“
- å¯»æ‰¾æœ€ä¼˜çš„CFGæˆªæ–­æ—¶æœº

### **4. è·¨ä¸“å®¶è¿ç»­æ€§**
- åˆ†æä¸“å®¶åˆ‡æ¢å‰åçš„latentè¿ç»­æ€§
- è¯„ä¼°MoEæ¶æ„å¯¹æ—¶åºä¸€è‡´æ€§çš„å½±å“

---

**å®éªŒæ—¶é—´**: 2025å¹´1æœˆ
**å®éªŒç¯å¢ƒ**: NVIDIA A100 80GB
**æ¨¡å‹ç‰ˆæœ¬**: WAN2.2-27B (T2V-A14B)

