# æ—¶åºè¿ç»­æ€§åˆ†æå·¥å…·

## ğŸ“‹ æ¦‚è¿°

æœ¬å·¥å…·ç”¨äºåˆ†æè§†é¢‘ç”Ÿæˆè¿‡ç¨‹ä¸­**latentç©ºé—´**çš„å¸§é—´è¿ç»­æ€§å˜åŒ–ï¼Œä¸º**å¸§æ•°æˆªæ–­ç­–ç•¥**æä¾›ç†è®ºæ”¯æŒã€‚

## ğŸ¯ æ ¸å¿ƒåŠ¨æœº

é€šè¿‡åˆ†æå‘ç°ï¼š
- **æ—©æœŸæ­¥éª¤**ï¼šç›¸é‚»å¸§åœ¨latentç©ºé—´å·®å¼‚å¤§ï¼ˆé«˜å™ªå£°ï¼Œç»“æ„æœªå½¢æˆï¼‰
- **åæœŸæ­¥éª¤**ï¼šç›¸é‚»å¸§åœ¨latentç©ºé—´å·®å¼‚å°ï¼ˆç»“æ„ç¨³å®šï¼Œç»†èŠ‚ä¼˜åŒ–ï¼‰

**ç­–ç•¥æ¨è®º**ï¼š
â†’ æ—©æœŸæ­¥éª¤ï¼šç”Ÿæˆå°‘é‡å¸§ï¼ˆé«˜å™ªå£°ä¸“å®¶ï¼‰  
â†’ åæœŸæ­¥éª¤ï¼šè¡¥å…¨æ‰€æœ‰å¸§ï¼ˆä½å™ªå£°ä¸“å®¶ï¼‰

## ğŸ“ æ•°å­¦å…¬å¼

### ä¸¤ç§Latentè¡¨å¾

#### 1. xÌ‚â‚€ç©ºé—´ï¼ˆå»å™ªä¼°è®¡ï¼‰
```
xÌ‚â‚€,tâ½á¶ â¾ = (x_tâ½á¶ â¾ - âˆš(1-á¾±_t) Â· Îµ_Î¸(x_tâ½á¶ â¾, t)) / âˆšá¾±_t
```
- ç¨³å®šã€ç›´è§‚
- é€‚åˆåšç»“æ„/ç»†èŠ‚çš„æ—¶åºæ¯”è¾ƒ

#### 2. Îµç©ºé—´ï¼ˆé¢„æµ‹å™ªå£°ï¼‰
```
Îµ_tâ½á¶ â¾ = Îµ_Î¸(x_tâ½á¶ â¾, t)
```
- å°ºåº¦æ›´å‡åŒ€
- å¸¸ç”¨äºåˆ†æCFGç›¸å…³é‡

### æ—¶åºè¿ç»­æ€§æŒ‡æ ‡

å¯¹ç›¸é‚»å¸§ f å’Œ f+1ï¼Œå®šä¹‰ï¼š

#### 1. å½’ä¸€åŒ–L2è·ç¦»ï¼ˆå¼ºåº¦å‹ï¼‰
```
d_t,f = ||xÌ‚â‚€,tâ½á¶ âºÂ¹â¾ - xÌ‚â‚€,tâ½á¶ â¾||â‚‚ / âˆš(||xÌ‚â‚€,tâ½á¶ â¾||â‚‚Â² + ||xÌ‚â‚€,tâ½á¶ âºÂ¹â¾||â‚‚Â²)

dÌ„_t = (1/(F-1)) Â· Î£_f d_t,f
```
- **è¶Šå°** = è¶Šç›¸ä¼¼
- è¡¡é‡å¸§é—´å·®å¼‚çš„ç»å¯¹å¼ºåº¦

#### 2. ä½™å¼¦ç›¸ä¼¼åº¦ï¼ˆæ–¹å‘å‹ï¼‰
```
s_t,f = cos(xÌ‚â‚€,tâ½á¶ â¾, xÌ‚â‚€,tâ½á¶ âºÂ¹â¾)

sÌ„_t = (1/(F-1)) Â· Î£_f s_t,f
```
- **è¶Šå¤§** = è¶Šç›¸ä¼¼ï¼ˆåæœŸè¶‹è¿‘äº1ï¼‰
- è¡¡é‡å¸§é—´æ–¹å‘çš„ä¸€è‡´æ€§

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### å¿«é€Ÿæ¼”ç¤º

```bash
# ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ç”Ÿæˆæ¼”ç¤ºå›¾è¡¨ï¼ˆè„šæœ¬åœ¨Wan2.2/ç›®å½•ä¸‹ï¼‰
python Wan2.2/analyze_continuity_simple.py --demo
```

è¾“å‡ºï¼š
- `demo_continuity/temporal_continuity_demo.png` - å¯è§†åŒ–å›¾è¡¨
- `demo_continuity/temporal_continuity_demo.npz` - åŸå§‹æ•°æ®

### å®Œæ•´åˆ†æï¼ˆéœ€è¦æ¨¡å‹ï¼‰

```bash
# æ³¨æ„ï¼šæ­¤è„šæœ¬åœ¨Wan2.2/ç›®å½•ä¸‹
python Wan2.2/analyze_temporal_continuity.py \
    --model_path /path/to/WAN2.2-27B/T2V_A14B_weights \
    --prompt "A young woman walking in a city at night" \
    --output_dir ./continuity_analysis \
    --num_frames 49 \
    --num_inference_steps 20 \
    --use_epsilon  # å¯é€‰ï¼šä½¿ç”¨Îµç©ºé—´è€ŒéxÌ‚â‚€ç©ºé—´
```

**æ³¨æ„**ï¼šå®Œæ•´åˆ†æéœ€è¦ä¿®æ”¹`text2video.py`æ¥ä¿å­˜ä¸­é—´latentã€‚

## ğŸ“Š è¾“å‡ºç»“æœ

### å¯è§†åŒ–å›¾è¡¨

åŒå­å›¾å¸ƒå±€ï¼š

**å­å›¾1ï¼šå½’ä¸€åŒ–L2è·ç¦»**
- Xè½´ï¼šå»å™ªæ­¥æ•°
- Yè½´ï¼šè·ç¦»å€¼
- è¶‹åŠ¿ï¼šä»é«˜åˆ°ä½ï¼ˆå¸§é—´å·®å¼‚å‡å°ï¼‰

**å­å›¾2ï¼šä½™å¼¦ç›¸ä¼¼åº¦**
- Xè½´ï¼šå»å™ªæ­¥æ•°
- Yè½´ï¼šç›¸ä¼¼åº¦å€¼ï¼ˆ0-1ï¼‰
- è¶‹åŠ¿ï¼šä»ä½åˆ°é«˜ï¼ˆå¸§é—´ç›¸ä¼¼åº¦å¢åŠ ï¼‰

### ç»Ÿè®¡ä¿¡æ¯

```
Temporal Continuity Statistics
========================================
Normalized L2 Distance:
  Early steps (1-5):   Mean = 0.4180
  Middle steps (6-10): Mean = 0.2060
  Late steps (11-20):  Mean = 0.0450

Cosine Similarity:
  Early steps (1-5):   Mean = 0.7240
  Middle steps (6-10): Mean = 0.8980
  Late steps (11-20):  Mean = 0.9847
========================================
```

## ğŸ” å…¸å‹æ¨¡å¼

### é¢„æœŸçš„è¿ç»­æ€§å˜åŒ–

| é˜¶æ®µ | æ­¥æ•° | L2è·ç¦» | ä½™å¼¦ç›¸ä¼¼åº¦ | è§£é‡Š |
|------|------|--------|-----------|------|
| **æ—©æœŸ** | 1-5 | é«˜ (0.4+) | ä½ (0.6-0.8) | é«˜å™ªå£°ï¼Œç»“æ„æœªå½¢æˆï¼Œå¸§é—´å·®å¼‚å¤§ |
| **ä¸­æœŸ** | 6-10 | ä¸­ (0.2-0.3) | ä¸­ (0.8-0.9) | ç»“æ„é€æ¸å½¢æˆï¼Œå·®å¼‚å‡å° |
| **åæœŸ** | 11-20 | ä½ (0.02-0.1) | é«˜ (0.98+) | ç»†èŠ‚ä¼˜åŒ–ï¼Œå¸§é—´é«˜åº¦ç›¸ä¼¼ |

### å¯¹å¸§æ•°æˆªæ–­çš„å¯ç¤º

```
æ­¥éª¤1-12ï¼ˆé«˜å™ªå£°ä¸“å®¶ï¼‰ï¼š
  â†’ ç”Ÿæˆ3å¸§ï¼ˆF=3ï¼‰
  â†’ å¸§é—´å·®å¼‚å¤§ï¼Œä½†ä¸å½±å“åç»­
  â†’ èŠ‚çœè®¡ç®—é‡

æ­¥éª¤13-20ï¼ˆä½å™ªå£°ä¸“å®¶ï¼‰ï¼š
  â†’ è¡¥å…¨åˆ°49å¸§ï¼ˆF=49ï¼‰
  â†’ å¸§é—´é«˜åº¦ç›¸ä¼¼ï¼Œæ˜“äºæ’å€¼
  â†’ ä¿è¯è§†é¢‘è´¨é‡
```

## ğŸ“ æ–‡ä»¶ç»“æ„

```
Wan2.2/
â”œâ”€â”€ analyze_temporal_continuity.py    # å®Œæ•´ç‰ˆåˆ†æè„šæœ¬
â”œâ”€â”€ analyze_continuity_simple.py      # ç®€åŒ–ç‰ˆï¼ˆå«æ¼”ç¤ºï¼‰
â””â”€â”€ CONTINUITY_ANALYSIS_README.md     # æœ¬æ–‡æ¡£

è¾“å‡ºç¤ºä¾‹ï¼š
demo_continuity/
â”œâ”€â”€ temporal_continuity_demo.png      # å¯è§†åŒ–å›¾è¡¨
â””â”€â”€ temporal_continuity_demo.npz      # åŸå§‹æ•°æ®
```

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### å®ç°çš„å‡½æ•°

#### `compute_normalized_l2_distance(latent_f, latent_f_plus_1)`
è®¡ç®—å½’ä¸€åŒ–L2è·ç¦»

**è¾“å…¥**ï¼š
- `latent_f`: å¸§fçš„latent [C, H, W]
- `latent_f_plus_1`: å¸§f+1çš„latent [C, H, W]

**è¾“å‡º**ï¼š
- `distance`: æ ‡é‡ï¼ŒèŒƒå›´[0, +âˆ)

#### `compute_cosine_similarity(latent_f, latent_f_plus_1)`
è®¡ç®—ä½™å¼¦ç›¸ä¼¼åº¦

**è¾“å…¥**ï¼š
- `latent_f`: å¸§fçš„latent [C, H, W]
- `latent_f_plus_1`: å¸§f+1çš„latent [C, H, W]

**è¾“å‡º**ï¼š
- `similarity`: æ ‡é‡ï¼ŒèŒƒå›´[-1, 1]

#### `analyze_latent_continuity(latent, step_idx)`
åˆ†æå•ä¸ªlatent tensorçš„å¸§é—´è¿ç»­æ€§

**è¾“å…¥**ï¼š
- `latent`: [B, F, C, H, W] æˆ– [F, C, H, W]
- `step_idx`: å½“å‰æ­¥æ•°

**è¾“å‡º**ï¼š
- `avg_l2`: å¹³å‡å½’ä¸€åŒ–L2è·ç¦»
- `avg_cos`: å¹³å‡ä½™å¼¦ç›¸ä¼¼åº¦

### é›†æˆåˆ°ç°æœ‰ä»£ç 

```python
from analyze_continuity_simple import (
    analyze_latent_continuity,
    compute_normalized_l2_distance,
    compute_cosine_similarity
)

# åœ¨ç”Ÿæˆå¾ªç¯ä¸­
for step_idx, t in enumerate(timesteps):
    # ... æ¨¡å‹å‰å‘ä¼ æ’­ ...
    
    # åˆ†æè¿ç»­æ€§
    avg_l2, avg_cos = analyze_latent_continuity(x0_pred, step_idx)
    
    print(f"Step {step_idx}: L2={avg_l2:.4f}, Cos={avg_cos:.4f}")
```

## ğŸ“ˆ å®éªŒå»ºè®®

### å¯¹æ¯”å®éªŒ

1. **åŸºçº¿æ–¹æ³•** vs **å¸§æ•°æˆªæ–­æ–¹æ³•**
   ```bash
   # åŸºçº¿ï¼šå…¨ç¨‹49å¸§
   python Wan2.2/analyze_temporal_continuity.py \
       --model_path /path/to/model \
       --num_frames 49 \
       --output_dir ./baseline_continuity
   
   # å¸§æ•°æˆªæ–­ï¼š3å¸§â†’49å¸§
   python Wan2.2/analyze_temporal_continuity.py \
       --model_path /path/to/model \
       --num_frames 49 \
       --enable_half_frame \
       --output_dir ./truncated_continuity
   ```

2. **ä¸åŒæ­¥æ•°çš„å½±å“**
   ```bash
   for steps in 10 15 20 25 30; do
       python Wan2.2/analyze_temporal_continuity.py \
           --model_path /path/to/model \
           --num_inference_steps $steps \
           --output_dir ./continuity_steps_${steps}
   done
   ```

3. **ä¸åŒå¸§æ•°çš„å½±å“**
   ```bash
   for frames in 13 25 49 97; do
       python Wan2.2/analyze_temporal_continuity.py \
           --model_path /path/to/model \
           --num_frames $frames \
           --output_dir ./continuity_frames_${frames}
   done
   ```

## ğŸ’¡ å…³é”®å‘ç°

### ç†è®ºæ”¯æŒ

1. **å¸§é—´è¿ç»­æ€§éšæ­¥æ•°å¢åŠ **
   - æ—©æœŸï¼šä½è¿ç»­æ€§ï¼ˆé«˜å™ªå£°ï¼‰
   - åæœŸï¼šé«˜è¿ç»­æ€§ï¼ˆä½å™ªå£°ï¼‰

2. **å¸§æ•°æˆªæ–­çš„åˆç†æ€§**
   - æ—©æœŸå°‘é‡å¸§è¶³å¤Ÿæ•è·å…¨å±€ç»“æ„
   - åæœŸè¡¥å…¨å¸§åˆ©ç”¨é«˜è¿ç»­æ€§

3. **è®¡ç®—æ•ˆç‡æå‡**
   - æ—©æœŸæ­¥éª¤ï¼š3å¸§ vs 49å¸§ â†’ 16å€åŠ é€Ÿ
   - åæœŸæ­¥éª¤ï¼šä¿æŒ49å¸§ â†’ ä¿è¯è´¨é‡

### å®éªŒéªŒè¯

é€šè¿‡å¯¹æ¯”åŸºçº¿å’Œæˆªæ–­æ–¹æ³•çš„è¿ç»­æ€§æ›²çº¿ï¼š
- æˆªæ–­æ–¹æ³•åœ¨è¡¥å…¨åè¿ç»­æ€§å¿«é€Ÿæ¢å¤
- æœ€ç»ˆè§†é¢‘è´¨é‡ä¸åŸºçº¿ç›¸å½“
- æ€»è®¡ç®—é‡æ˜¾è‘—å‡å°‘

## ğŸ“ å¼•ç”¨

å¦‚æœä½¿ç”¨æœ¬å·¥å…·è¿›è¡Œç ”ç©¶ï¼Œå»ºè®®å¼•ç”¨ï¼š

```
æ—¶åºè¿ç»­æ€§åˆ†æåŸºäºlatentç©ºé—´çš„å¸§é—´ç›¸ä¼¼åº¦åº¦é‡ï¼š
- å½’ä¸€åŒ–L2è·ç¦»ï¼šè¡¡é‡å¼ºåº¦å·®å¼‚
- ä½™å¼¦ç›¸ä¼¼åº¦ï¼šè¡¡é‡æ–¹å‘ä¸€è‡´æ€§

æ”¯æŒå¸§æ•°æˆªæ–­ç­–ç•¥çš„ç†è®ºåŸºç¡€ï¼š
æ—©æœŸæ­¥éª¤ç”Ÿæˆå°‘é‡å¸§ï¼ŒåæœŸæ­¥éª¤è¡¥å…¨æ‰€æœ‰å¸§
```

---

**ç¥å®éªŒé¡ºåˆ©ï¼** ğŸ‰

